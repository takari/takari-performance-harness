<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
        "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
	<title>Performance Tests HowTo. Part 2</title>
	<meta name="generator" content="BBEdit 7.1.4">
</head>
<body>

<h2>Performance Tests HowTo, Part 2: 
<br>Setting up the Cloudscape database</h2>


The Eclipse performance test plugin (org.eclipse.test.performance) provides infrastructure for instrumenting programs to collect performance data and to assert that performance doesn't drop below a baseline.
<p>

This functionality requires that a specific database (<a href="http://www-306.ibm.com/software/data/cloudscape/">Cloudscape</a>) is available and can be used via JDBC. This HowTo document describes how to install Cloudscape and how to configure the performance test plugin to use Cloudscape.
<p>
 
<h2>How to get Cloudscape</h2>

If you don't have access to the "Cloudscape" project in the following repository:
<pre>
  :extssh:anonymous@ottcvs1.ott.oti.com:/home/cvs/zrheclipse
</pre>
you can download Cloudscape from <a href="http://www-106.ibm.com/developerworks/db2/library/techarticle/dm-0408cline/index.html">here</a>.

<p>
In addition you'll need to load the performance plugin (org.eclipse.test.performance) and if you are running on Windows the associated fragment (org.eclipse.test.performance.win32).


<h2>Configuration</h2>

The performance test plugin is configured via a single Java property called <code>perf_ctrl</code>. The value of this property is a list of key/value pairs separated by semicolons. Each key/value pair uses a '=' as a separator: 
<pre>
-Dperf_ctrl=<i>key1</i>=<i>value1</i>;<i>key2</i>=<i>value2</i>;...;<i>keyn</i>=<i>valuen</i>
</pre>
This first release of the performance test plugin supports the following key/value pairs:
<dl>
<dt><code>dbloc=<i>&lt;databse location&gt;</i></code></dt>
<dd>
specifies where the Cloudscape DB is located.
If no value is given
<pre>
	-Dperf_ctrl=dbloc=
</pre>
Cloudscape runs in embedded mode (not as a separate server)
and the DB will live in your home directory.
If an absolute or relative path is given, Cloudscape uses or creates the DB in that location. E.g. with
<pre>
	-Dperf_ctrl=dbloc=/tmp/cloudscape
</pre>
Cloudscape runs in embedded mode and creates the database under /tmp/cloudscape.
To connect to a cloudscape server running locally or remotely use the following:
<pre>
	-Dperf_ctrl=dbloc=net://<i>tcp/ip address</i>
</pre>
</dd>

<p>
<dt><code>build=<i>&lt;name of build&gt;</i></code></dt>
<dd>
This key/value pair tags the collected data with another name. Typically the name of the build that was used to produce the data is used here. So in this example:
<pre>
	-Dperf_ctrl=dbloc=net://perfserver;build=N20040914
</pre>
performance data for the nightly build N20040914 is stored on the server "perfserver".
If the tests are run multiple times with the same arguments, the new data does not replace old data but is added under the same name. Programs
that visualize the data are expected to aggregate the data for example by calculating the average of all tests.
</dd>
<p>
<dt><code>assertAgainst=<i>&lt;name of build&gt;</i></code></dt>
<dd>
This key/value pair is used to enable the "assertPerformance" calls in performance tests. The  value for this key specifies the "build" name of the reference data to compare against. So in the following example the performance data is stored in the database under the build name "N20040914" and the "assertPerformance" compares the data tagged "N20040914" against the data tagged "Base3.0":
<pre>
	-Dperf_ctrl=dbloc=net://perfserver;build=N20040914;assertAgainst=Base3.0
</pre>
If you want to assert the average of multiple runs (instead of the data of a single run) against the reference data, do the following:
<pre>
	// Run program 4 times to collect data under build name "I20040914"
	... -Dperf_ctrl=dbloc=;build=I20040914
	... -Dperf_ctrl=dbloc=;build=I20040914
	... -Dperf_ctrl=dbloc=;build=I20040914
	... -Dperf_ctrl=dbloc=;build=I20040914

	// Run program a 5th time and collect more data under I20040914
	// and assert the average of 5 runs of I20040914 against some Baseline data
	... -Dperf_ctrl=dbloc=;build=I20040914;assertAgainst=Baseline
</pre>
</dd>
<p>

<dt><code>config=<i>&lt;name of configuration&gt;</i></code></dt>
<dd>
This key/value pair establishes a name space for the collected data.
All data collected in the DB is automatically "prefixed" with this name and all tests performed against reference data uses this name as a prefix too. Typically you would use a symbolic name of a specific configuration as a value for <code>config</code>. E.g. <code>RelengPerfTestWin</code> for all performance tests run on Windows and <code>RelengPerfTestWin</code> for the same tests run on Linux.
<p>
If no config name is specified and if Cloudscape runs in embedded mode, the config name will default to <code>localhost</code>. If Cloudscape runs non-embedded, the DNS name of the client's TCP/IP-address will be used. Having this name space mechanism helps preventing that data collected for one configuration accidentely pollutes the data for a different configuration.
<dd>

</dl>


<h2>Viewing the data</h2>

Since we do not yet have fancy visualization tools, the performance test plugin provides two classes that can be run as standalone programs for "dumping" the data contained in the database.
For both programs you need to specify the database location via the <code>perf_ctrl</code> property (most easily done via a launch configuration).
<ul>
<li>
To view the data in a tabular format use the class 
<code>org.eclipse.test.internal.performance.db.View</code>. It produces the following output:
<pre>
Scenario: org.eclipse.jdt.ui.tests.performance.views.PackageExplorerPerfTest#testOpen()
Builds:                 base          b0003       b0004       b0007       b0008          b0009
Kernel time:       30 ms [0]     10 ms [10]    0 ms [0]    0 ms [0]   20 ms [0]   13 ms [12.5]
Elapsed Process:  325 ms [0]  491 ms [94.5]  358 ms [0]  296 ms [0]  316 ms [0]  304 ms [19.6]
User time:        240 ms [0]    305 ms [45]  270 ms [0]  270 ms [0]  260 ms [0]   240 ms [8.2]
System Time:      325 ms [0]  491 ms [94.5]  358 ms [0]  296 ms [0]  316 ms [0]  304 ms [19.6]
CPU Time:         270 ms [0]    315 ms [55]  270 ms [0]  270 ms [0]  280 ms [0]   253 ms [4.7]
</pre>
If you don't want to see all data in the database you can 
modify the three SQL wildcards ("%") in the call to <code>DB.queryScenarios</code>.
<p>
</li>
<li>
To dump the (quite voluminous) contents of all database tables run 
<code>org.eclipse.test.internal.performance.db.DB</code>.
</li>
</ul>

<h2>How to setup a Cloudscape server (on Linux and MacOS X)</h2>

<ul>
<li>
Either get Cloudscape from the repository or from <a href="http://www-106.ibm.com/developerworks/db2/library/techarticle/dm-0408cline/index.html">here</a>.
<p>
</li>
<li>
Get the (Bourne) shell script "cs.sh" from the scripts folder of <code>org.eclipse.test.performance</code>
and install it on the server (rename it to "cs" and make it executable).
The script simplifies the usage of the Cloudscape tools - especially starting and stopping the server - because it sets the correct classpath and some important properties.
<p>
</li>
<li>
Edit the script and adapt the variables <code>CSLIB</code>, <code>DBROOT</code>, and <code>JAVA</code> to your installation. <code>CSLIB</code> should point to the directory containing the Cloudscape jars. If you've used the Cloudscape installer, then this is the lib directory inside the Cloudscape 10.0 directory. If you are using the Cloudscape project from the repository, then this is just the project folder.
<p>
</li>
<li>
in a Shell execute
<pre>
	cs start &
</pre>
to launch the server in background. The server will print a
<pre>
	Server is ready to accept connections on port 1527.
</pre>
to the console.
</li>
<p>
<li>
stop the server with
<pre>
	cs stop
</pre>
</li>
</ul>


</body>
</html>
